---

- name: pre-run
  dci_job:
    id: "{{ job_id }}"
    status: "pre-run"
  tags: [dci]

- name: Install packages for deprecated-api feature
  block:
    - name: Install junitparser
      pip:
        name:
          - junitparser
      become: true

    - name: Install semver
      dnf:
        name: python3-semver
        state: present
      become: true
  when:
    - ocp_version is version("4.9", ">=")
    - do_deprecated_api | bool

- name: Include installed software and git repos as components
  vars:
    mandatory_rpms:
      - ansible
      - dci-openshift-app-agent
      - dci-pipeline
      - podman
      - python3-dciclient
      - python3-kubernetes
      - python3-openshift
    ic_rpms: "{{ (dci_rpms_to_components + mandatory_rpms)|flatten }}"
    ic_gits: "{{ dci_gits_to_components|flatten }}"
    ic_dev_gits: "{{ dev_gits_to_components|flatten }}"
  include_role:
    name: include-components

- name: Compute if all needed components are ga
  vars:
    ga_components: "{{ job_info['job']['components'] | selectattr('tags', 'issuperset', ['build:ga']) | map(attribute='type') | list }}"
  set_fact:
    dci_all_components_are_ga: "{{ dci_ga_components_for_certification | difference(ga_components) | length == 0 }}"

- name: Get deprecated API before running workload
  shell: >
    set -o pipefail &&
    {{ oc_tool_path }} get -o json apirequestcounts
    | jq -r '.items[] | select(.status.removedInRelease!=null)'
    | jq -s '.'
    > {{ job_logs.path }}/apirequestcounts.before.json
  when:
    - ocp_version is version("4.9", ">=")
    - do_deprecated_api | bool

### Mirror must-gather images

- name: "dci-openshift-app-agent : Mirror must gather images"
  include_role:
    name: mirror_images
  vars:
    images: "{{ dci_must_gather_images | default(['registry.redhat.io/openshift4/ose-must-gather']) }}"
    authfile: "{{ pullsecret_tmp_file }}"
  when:
    - dci_disconnected | default(false) | bool
    - dci_local_registry | length
    - do_must_gather | bool
...
