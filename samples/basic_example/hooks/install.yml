---
- name: "Labeling namespace to comply with PodSecurity profiles"
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ app_ns }}"
        labels:
          security.openshift.io/scc.podSecurityLabelSync: "false"
          pod-security.kubernetes.io/enforce: "baseline"
          pod-security.kubernetes.io/enforce-version: "latest"
          pod-security.kubernetes.io/warn: "baseline"

- name: Wait until namespace has openshift.io/sa.scc.uid-range annotation
  community.kubernetes.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ app_ns }}"
  register: namespace_annotations
  retries: 15
  delay: 5
  until:
    - namespace_annotations.resources|length == 1
    - namespace_annotations.resources[0].metadata.annotations["openshift.io/sa.scc.uid-range"] is defined

- name: Create a simple pod
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        app: httpd
        name: webserver
        namespace: "{{ app_ns }}"
      spec:
        containers:
          - name: webserver
            image: "{{ dci_openshift_app_image | default('docker.io/library/nginx') }}"
            securityContext:
              capabilities: {}
            ports:
              - containerPort: 80
            livenessProbe:
              failureThreshold: 3
              httpGet:
                path: /
                port: 80
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 30
            successThreshold: 1
...
