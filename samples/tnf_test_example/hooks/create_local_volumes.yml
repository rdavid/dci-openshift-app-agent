- name: Create local volume
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: "volume-{{ volume_name_suffix }}"
      spec:
        capacity:
          storage: 10Mi
        volumeMode: Filesystem
        accessModes:
        - ReadWriteOnce
        persistentVolumeReclaimPolicy: Delete
        storageClassName: local-storage
        claimRef:
          namespace: "{{ app_ns }}"
          name: "volume-claim-{{ volume_name_suffix }}"
        local:
          path: /tmp
        nodeAffinity:
          required:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-role.kubernetes.io/worker
                operator: In
                values:
                - ""

- name: Wait until volume is available
  community.kubernetes.k8s_info:
    api_version: v1
    kind: PersistentVolume
    name: "volume-{{ volume_name_suffix }}"
  register: pv_check
  until:
    - pv_check.resources is defined
    - pv_check.resources[0].status.phase == "Available"
  retries: 6
  delay: 10
