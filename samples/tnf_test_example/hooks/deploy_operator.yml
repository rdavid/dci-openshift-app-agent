---

- name: Create CatalogSource for operator
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: "{{ tnf_operator_to_install.operator_name }}-catalog"
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: "{{ catalog_path | default('registry.redhat.io/redhat/certified-operator-index:v' + ocp_version) }}"
        displayName: Operator
        updateStrategy:
          registryPoll:
            interval: 30m

- name: "deploy-operators : Install operator"
  include_role:
    name: olm-operator
  vars:
    operator: "{{ tnf_operator_to_install.operator_name }}"
    source: "{{ tnf_operator_to_install.operator_name }}-catalog"
    namespace: "{{ target_ns }}"
    operator_group_spec:
      targetNamespaces:
        - "{{ target_ns }}"

- name: "Get current subscription"
  community.kubernetes.k8s_info:
    api: operators.coreos.com/v1alpha1
    kind: Subscription
    namespace: "{{ target_ns }}"
    name: "{{ tnf_operator_to_install.operator_name }}"
  register: current_subscription

- name: "Get Installed CSV and subscription name"
  vars:
    subs_details: >
      resources[*].{ subscriptionName: metadata.name,
        installedCSV: status.installedCSV
      }
  set_fact:
    subscription: "{{ current_subscription | json_query(subs_details) | first }}"

- name: "Update CSVs with autodiscovery labels/annotations to execute test suites"
  community.kubernetes.k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: ClusterServiceVersion
      metadata:
        name: "{{ subscription.installedCSV }}"
        namespace: "{{ target_ns }}"
        labels:
          test-network-function.com/operator: target
        annotations:
          test-network-function.com/operator_tests: "['OPERATOR_STATUS']"
          test-network-function.com/subscription_name: "{{ subscription.subscriptionName }}"

...
