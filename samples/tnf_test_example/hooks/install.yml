---
- name: Check if there are RuntimeClass resources installed
  community.kubernetes.k8s_info:
    api_version: node.k8s.io/v1
    kind: RuntimeClass
  register: runtime_class_check

- name: Take the first RuntimeClass if exists and extract its name
  set_fact:
    runtime_class_name: "{{ runtime_class_check.resources[0].metadata.name }}"
  when: runtime_class_check.resources|length

# If the namespace is dci_openshift_app_ns, its creation is handled in
# d-o-a-a plays, so we do not need to do that here.
# exclude_connectivity_regexp is not checked because it is optional.
- name: Create namespaces and deploy test resources on each namespace if not done before
  include_tasks: deploy_resources_in_ns.yml
  vars:
    app_ns: "{{ pods_in_same_ns.namespace }}"
    targetpodlabels: "{{ pods_in_same_ns.targetpodlabels }}"
    target_crds: "{{ pods_in_same_ns.target_crds }}"
    exclude_connectivity_regexp: "{{ pods_in_same_ns.exclude_connectivity_regexp|default('') }}"
  when:
    - tnf_config is defined
    - tnf_config|length
    - pods_in_same_ns.namespace is defined
    - pods_in_same_ns.namespace|length
    - pods_in_same_ns.targetpodlabels is defined
    - pods_in_same_ns.targetpodlabels is iterable
    - pods_in_same_ns.target_crds is defined
    - pods_in_same_ns.target_crds is iterable
  loop: "{{ tnf_config }}"
  loop_control:
    loop_var: pods_in_same_ns

- name: Create NetworkPolicies for the pods deployed to allow inter-intra namespaces traffic
  community.kubernetes.k8s:
    state: present
    definition: "{{ lookup('template', 'templates/network_policies_allow_traffic.yml.j2') | from_yaml }}"
  when:
    - tnf_config is defined
    - tnf_config|length

# Install the operator in test-cnf namespace
- name: Set operator_ns variable
  set_fact:
    operator_ns: "{{ tnf_config[0].namespace|default('test-cnf') }}"

- name: Create CatalogSource for simple-demo-operator
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: simple-demo-operator-catalog
        namespace: openshift-marketplace
      spec:
        sourceType: grpc
        image: "{{ catalog_path | default('quay.io/opdev/simple-demo-operator-catalog:v0.0.6') }}"
        displayName: Simple Demo Operator
        updateStrategy:
          registryPoll:
            interval: 30m

- name: "deploy-operators : Install simple-demo-operator"
  include_role:
    name: olm-operator
  vars:
    operator: "{{ tnf_operator_to_install.operator_name | default('simple-demo-operator') }}"
    source: "{{ tnf_operator_to_install.operator_name | default('simple-demo-operator') }}-catalog"
    namespace: "{{ operator_ns }}"
    operator_group_spec:
      targetNamespaces:
        - "{{ operator_ns }}"

- name: "Get current subscription"
  community.kubernetes.k8s_info:
    api: operators.coreos.com/v1alpha1
    kind: Subscription
    namespace: "{{ operator_ns }}"
    name: "{{ tnf_operator_to_install.operator_name | default('simple-demo-operator') }}"
  register: current_subscription

- name: "Get Installed CSV and subscription name"
  vars:
    subs_details: >
      resources[*].{ subscriptionName: metadata.name,
        installedCSV: status.installedCSV
      }
  set_fact:
    subscription: "{{ current_subscription | json_query(subs_details) | first }}"

- name: "Update CSVs with autodiscovery labels/annotations to execute test suites"
  community.kubernetes.k8s:
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: ClusterServiceVersion
      metadata:
        name: "{{ subscription.installedCSV }}"
        namespace: "{{ operator_ns }}"
        labels:
          test-network-function.com/operator: target
        annotations:
          test-network-function.com/operator_tests: "['OPERATOR_STATUS']"
          test-network-function.com/subscription_name: "{{ subscription.subscriptionName }}"
