---

- name: Delete testing resources
  include_tasks: delete_testing_resources.yml
  loop: "{{ tnf_config }}"
  loop_control:
    loop_var: pods_in_same_ns
  when:
    - tnf_config | default('') | length
    - pods_in_same_ns.namespace | default('') | length

- name: Delete SCC Category 1 - CNFs that require Service Mesh
  community.kubernetes.k8s:
    api_version: security.openshift.io/v1
    name: restricted-cat-1
    kind: SecurityContextConstraints
    state: absent
    wait: yes
    wait_sleep: 5
    wait_timeout: 120

- name: Delete local-storage StorageClass if present
  community.kubernetes.k8s:
    api_version: storage.k8s.io/v1
    name: local-storage
    kind: StorageClass
    state: absent
    wait: yes
    wait_sleep: 5
    wait_timeout: 120

- name: Delete custom RuntimeClass
  community.kubernetes.k8s:
    api_version: node.k8s.io/v1
    name: production-runtime-class
    kind: RuntimeClass
    state: absent
    wait: yes
    wait_sleep: 5
    wait_timeout: 120

- name: "Cleanup CatalogSource"
  block:
    - name: Delete operator-catalog
      community.kubernetes.k8s:
        state: absent
        api_version: operators.coreos.com/v1alpha1
        name: "{{ tnf_operator_to_install.operator_name }}-catalog"
        namespace: openshift-marketplace
        kind: CatalogSource

    - name: Get OLM pod for catalog-operator
      community.kubernetes.k8s_info:
        api_version: v1
        kind: Pod
        namespace: openshift-operator-lifecycle-manager
        label_selectors:
          - app=catalog-operator
      register: olm_pod

    - name: Restart matching pods
      community.kubernetes.k8s:
        definition: |
          {{ item }}
        state: absent
      loop: "{{ olm_pod.resources }}"

    - name: Wait for OLM pod catalog-operator to be running
      community.kubernetes.k8s_info:
        kind: Pod
        namespace: openshift-operator-lifecycle-manager
        label_selectors:
          - app=catalog-operator
      register: olm_pod
      until: olm_pod | json_query('resources[*].status.phase') | unique == ["Running"]
      retries: 6
      delay: 10
  when:
    - tnf_operator_to_install is defined
...
