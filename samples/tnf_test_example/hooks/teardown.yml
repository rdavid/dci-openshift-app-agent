---
# Despite dci_openshift_app_ns is deleted in agent's
# teardown, it will be removed here in order to delete
# the local volumes without issues.
- name: Delete namespaces if not done before
  community.kubernetes.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ pods_in_same_ns.namespace }}"
    state: absent
    wait: yes
    wait_sleep: 5
    wait_timeout: 120
  when:
    - tnf_config is defined
    - tnf_config|length
    - pods_in_same_ns.namespace is defined
    - pods_in_same_ns.namespace|length
  loop: "{{ tnf_config }}"
  loop_control:
    loop_var: pods_in_same_ns

- name: Delete local volumes created
  include_tasks: delete_local_volumes.yml
  vars:
    app_ns: "{{ pods_in_same_ns.namespace }}"
  when:
    - tnf_config is defined
    - tnf_config|length
    - pods_in_same_ns.namespace is defined
    - pods_in_same_ns.namespace|length
  loop: "{{ tnf_config }}"
  loop_control:
    loop_var: pods_in_same_ns
  when: app_ns == 'production-cnf'

- name: Delete local-storage StorageClass
  community.kubernetes.k8s:
    api_version: storage.k8s.io/v1
    name: local-storage
    kind: StorageClass
    state: absent
    wait: yes
    wait_sleep: 5
    wait_timeout: 120

- name: Delete simple-demo-operator-catalog
  community.kubernetes.k8s:
    state: absent
    api_version: operators.coreos.com/v1alpha1
    name: "{{ tnf_operator_to_install.operator_name }}-catalog"
    namespace: openshift-marketplace
    kind: CatalogSource
